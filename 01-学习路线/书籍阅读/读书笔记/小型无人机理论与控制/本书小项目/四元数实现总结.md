# 四元数MAV仿真实现总结

## 1. 概述

本次工作完成了基于四元数的MAV（微型飞行器）六自由度动力学仿真系统的实现。四元数表示法是航空航天领域的主流姿态表示方法，相比欧拉角具有无万向锁、计算效率高、数值稳定等优点。

## 2. 实现的模块

### 2.1 quaternion.py - 四元数工具模块

核心函数：
- `euler_to_quaternion(phi, theta, psi)` - 欧拉角转四元数
- `quaternion_to_euler(e)` - 四元数转欧拉角
- `quaternion_derivative(e, p, q, r, lambda_norm)` - 四元数时间导数（含正交控制）
- `quaternion_gravity_body(e, mass, g)` - 使用四元数计算体轴系重力
- `normalize_quaternion(e)` - 四元数归一化
- `quaternion_norm_error(e)` - 范数误差检测

### 2.2 mav_dynamics_quat.py - 四元数动力学模型

核心类：
- `StateIndexQuat` - 13维状态向量索引（含四元数e0,e1,e2,e3）
- `MAVDynamicsQuat` - 四元数动力学类
  - 支持12维欧拉角或13维四元数状态输入
  - RK4积分器
  - Coppelt-Wright正交性控制（λ=1000）

状态向量定义：
```
[pn, pe, pd, u, v, w, e0, e1, e2, e3, p, q, r]
  0   1   2  3  4  5  6   7   8   9  10 11 12
```

### 2.3 forces_moments_quat.py - 力与力矩计算

核心类：
- `ForcesAndMomentsQuat` - 支持四元数状态的力矩计算器
  - `compute_gravity_force_quat(state)` - 四元数重力计算
  - `compute(state, wind_body, controls, use_quaternion)` - 统一计算接口

### 2.4 mav_sim_quat.py - 四元数仿真主程序（推荐入口）

核心类：
- `MAVSimulationQuat` - 完整仿真类
  - 支持欧拉角/四元数状态输入
  - 风速模型集成
  - 四元数范数误差监控
  - 完整的结果可视化

### 2.5 quaternion_verification.py - 验证测试程序

包含5项验证测试：
1. 欧拉角↔四元数转换一致性
2. 四元数归一化有效性（λ控制）
3. 四元数重力计算正确性
4. 四元数仿真与欧拉角仿真对比
5. 大角度机动测试（万向锁区域）

## 3. 关键公式

### 3.1 四元数定义
```
e = [e₀, e₁, e₂, e₃]ᵀ
||e|| = 1 (单位四元数约束)
```

### 3.2 欧拉角到四元数转换
```
e₀ = cos(ψ/2)cos(θ/2)cos(φ/2) + sin(ψ/2)sin(θ/2)sin(φ/2)
e₁ = cos(ψ/2)cos(θ/2)sin(φ/2) - sin(ψ/2)sin(θ/2)cos(φ/2)
e₂ = cos(ψ/2)sin(θ/2)cos(φ/2) + sin(ψ/2)cos(θ/2)sin(φ/2)
e₃ = sin(ψ/2)cos(θ/2)cos(φ/2) - cos(ψ/2)sin(θ/2)sin(φ/2)
```

### 3.3 四元数运动学方程（式B.3）
```
ė = ½ · Ω(p,q,r) · e + λ(1 - ||e||²) · e

其中 Ω = [ 0  -p  -q  -r]
        [ p   0   r  -q]
        [ q  -r   0   p]
        [ r   q  -p   0]
```
λ=1000 用于Coppelt-Wright正交性控制

### 3.4 四元数重力表达式（式B.8）
```
fg = mg · [2(e₁e₃ - e₂e₀)]
          [2(e₂e₃ + e₁e₀)]
          [e₃² + e₀² - e₁² - e₂²]
```

## 4. 架构设计

采用"外部欧拉角 + 内部四元数"的混合架构：

```
用户接口层（欧拉角）
    ↓ euler_to_quaternion()
四元数计算层（内部）
    ↓ quaternion_to_euler()
输出显示层（欧拉角）
```

优点：
- 用户使用直观的欧拉角输入/输出
- 内部计算使用四元数避免万向锁
- 完全向后兼容

## 5. 验证结果

所有5项测试通过：

| 测试项 | 结果 | 说明 |
|--------|------|------|
| 欧拉角↔四元数转换 | ✓ 通过 | 最大误差 < 1e-10 rad |
| 四元数归一化 | ✓ 通过 | 范数误差 < 1e-6 |
| 重力计算 | ✓ 通过 | 最大误差 < 1e-10 N |
| 仿真对比 | ✓ 通过 | 位置误差0.0008m |
| 大角度机动 | ✓ 通过 | 无数值发散 |

## 6. 使用指南

### 6.1 推荐用法

```python
from mav_sim_quat import MAVSimulationQuat
from mav_params import ZagiParams

# 创建仿真
sim = MAVSimulationQuat(ZagiParams, dt=0.01)

# 设置初始状态（可用欧拉角形式）
initial_state = np.zeros(12)
initial_state[3] = 25.0   # u = 25 m/s
initial_state[2] = -100   # 高度 100m
sim.set_initial_state(initial_state)

# 设置控制
sim.set_controls(delta_e=-0.035, delta_t=0.5)

# 运行仿真
sim.simulate((0, 10))

# 查看结果
sim.plot_results()
```

### 6.2 获取四元数/欧拉角数据

```python
# 获取四元数历史
quat_history = sim.get_quaternion_history()  # shape: (N, 4)

# 获取欧拉角历史
euler_history = sim.get_euler_angles()  # shape: (N, 3)

# 检查四元数归一化质量
max_error = np.max(sim.quat_norm_error_history)
print(f"四元数最大范数误差: {max_error:.2e}")
```

## 7. 文件清单

| 文件 | 说明 | 状态 |
|------|------|------|
| quaternion.py | 四元数工具函数 | 新建 |
| mav_dynamics_quat.py | 四元数动力学 | 新建 |
| forces_moments_quat.py | 力矩计算（四元数版）| 新建 |
| mav_sim_quat.py | 仿真主程序（推荐）| 新建 |
| quaternion_verification.py | 验证测试 | 新建 |
| mav_simulation.py | 统一入口（已更新）| 更新 |
| 四元数/四元数公式汇总.md | 公式文档 | 新建 |

## 8. 后续开发建议

1. **所有新仿真程序应使用四元数版本** - 导入 `mav_sim_quat.py`
2. **不再使用纯欧拉角动力学** - `mav_dynamics.py` 仅用于向后兼容
3. **大角度机动必须用四元数** - 避免俯仰角接近±90°时的万向锁
4. **监控四元数范数误差** - 正常情况应 < 1e-6

---

完成日期: 2026-01-29
