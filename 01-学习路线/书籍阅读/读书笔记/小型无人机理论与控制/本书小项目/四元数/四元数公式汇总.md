# 四元数仿真公式汇总

本文档整理了基于四元数的MAV仿真所需的全部数学公式。

---

## 一、四元数基本定义

### 1.1 四元数表示

四元数是四个实数的有序列表，表示为 $\mathbb{R}^4$ 中的一个矢量：

$$
\boldsymbol{e} = \begin{pmatrix} e_0 \\ e_1 \\ e_2 \\ e_3 \end{pmatrix}
$$

其中：
- $e_0, e_1, e_2, e_3$ 是标量
- $e_0$ 为单位四元数的**标量部分**
- 向量部分定义为：$\boldsymbol{e} = e_1\boldsymbol{i}^i + e_2\boldsymbol{j}^i + e_3\boldsymbol{k}^i$

### 1.2 单位四元数约束

用四元数表示旋转时，需要**单位四元数**：

$$
\|\boldsymbol{e}\| = \sqrt{e_0^2 + e_1^2 + e_2^2 + e_3^2} = 1
$$

### 1.3 轴角表示

由单位矢量 $\boldsymbol{v}$ 指定的轴旋转角度 $\Theta$，则单位四元数为：

**标量部分**（与旋转幅度相关）：
$$
e_0 = \cos\left(\frac{\Theta}{2}\right)
$$

**矢量部分**（与旋转轴相关）：
$$
\boldsymbol{v}\sin\left(\frac{\Theta}{2}\right) = \begin{pmatrix} e_1 \\ e_2 \\ e_3 \end{pmatrix}
$$

---

## 二、欧拉角与四元数转换

### 2.1 四元数 → 欧拉角

对于四元数表征的旋转，相应的欧拉角计算为：

$$
\phi = \arctan2\left(2(e_0e_1 + e_2e_3),\ (e_0^2 + e_3^2 - e_1^2 - e_2^2)\right)
$$

$$
\theta = \arcsin\left(2(e_0e_2 - e_1e_3)\right)
$$

$$
\psi = \arctan2\left(2(e_0e_3 + e_1e_2),\ (e_0^2 + e_1^2 - e_2^2 - e_3^2)\right)
$$

**说明**：
- $\arctan2(y, x)$ 是两个参数的反正切操作，返回在 $[-\pi, \pi]$ 范围内的 $y/x$ 反正切
- 使用两个参数的符号确定返回值的象限
- 俯仰角 $\theta$ 仅定义在范围 $[-\pi/2, \pi/2]$

### 2.2 欧拉角 → 四元数

从偏航角 $\psi$、俯仰角 $\theta$ 和滚转角 $\phi$，计算相应的四元数：

$$
e_0 = \cos\frac{\psi}{2}\cos\frac{\theta}{2}\cos\frac{\phi}{2} + \sin\frac{\psi}{2}\sin\frac{\theta}{2}\sin\frac{\phi}{2}
$$

$$
e_1 = \cos\frac{\psi}{2}\cos\frac{\theta}{2}\sin\frac{\phi}{2} - \sin\frac{\psi}{2}\sin\frac{\theta}{2}\cos\frac{\phi}{2}
$$

$$
e_2 = \cos\frac{\psi}{2}\sin\frac{\theta}{2}\cos\frac{\phi}{2} + \sin\frac{\psi}{2}\cos\frac{\theta}{2}\sin\frac{\phi}{2}
$$

$$
e_3 = \sin\frac{\psi}{2}\cos\frac{\theta}{2}\cos\frac{\phi}{2} - \cos\frac{\psi}{2}\sin\frac{\theta}{2}\sin\frac{\phi}{2}
$$

---

## 三、四元数运动学方程

使用单位四元数来表示飞机姿态，描述飞机运动学和动力学的方程式(3.14)~式(3.17)可以改写为：

### 3.1 位置微分方程（B.1）

$$
\begin{pmatrix} \dot{p}_n \\ \dot{p}_e \\ \dot{p}_d \end{pmatrix} =
\begin{pmatrix}
(e_1^2 + e_0^2 - e_2^2 - e_3^2) & 2(e_1e_2 - e_3e_0) & 2(e_1e_3 + e_2e_0) \\
2(e_1e_2 + e_3e_0) & (e_2^2 + e_0^2 - e_1^2 - e_3^2) & 2(e_2e_3 - e_1e_0) \\
2(e_1e_3 - e_2e_0) & 2(e_2e_3 + e_1e_0) & (e_3^2 + e_0^2 - e_1^2 - e_2^2)
\end{pmatrix}
\begin{pmatrix} u \\ v \\ w \end{pmatrix}
$$

这就是**旋转矩阵** $R_b^i(\boldsymbol{e})$，用四元数表示的从机体系到惯性系的变换。

### 3.2 速度微分方程（B.2）

$$
\begin{pmatrix} \dot{u} \\ \dot{v} \\ \dot{w} \end{pmatrix} =
\begin{pmatrix} rv - qw \\ pw - ru \\ qu - pv \end{pmatrix} + \frac{1}{m}
\begin{pmatrix} f_x \\ f_y \\ f_z \end{pmatrix}
$$

### 3.3 四元数微分方程（B.3）

$$
\begin{pmatrix} \dot{e}_0 \\ \dot{e}_1 \\ \dot{e}_2 \\ \dot{e}_3 \end{pmatrix} = \frac{1}{2}
\begin{pmatrix}
0 & -p & -q & -r \\
p & 0 & r & -q \\
q & -r & 0 & p \\
r & q & -p & 0
\end{pmatrix}
\begin{pmatrix} e_0 \\ e_1 \\ e_2 \\ e_3 \end{pmatrix}
$$

展开形式：
$$
\dot{e}_0 = -\frac{1}{2}(pe_1 + qe_2 + re_3) \tag{B.11}
$$
$$
\dot{e}_1 = \frac{1}{2}(pe_0 + re_2 - qe_3) \tag{B.12}
$$
$$
\dot{e}_2 = \frac{1}{2}(qe_0 - re_1 + pe_3) \tag{B.13}
$$
$$
\dot{e}_3 = \frac{1}{2}(re_0 + qe_1 - pe_2) \tag{B.14}
$$

### 3.4 角速度微分方程（B.4）

$$
\begin{pmatrix} \dot{p} \\ \dot{q} \\ \dot{r} \end{pmatrix} =
\begin{pmatrix}
\Gamma_1 pq - \Gamma_2 qr \\
\Gamma_5 pr - \Gamma_6 (p^2 - r^2) \\
\Gamma_7 pq - \Gamma_1 qr
\end{pmatrix} +
\begin{pmatrix}
\Gamma_3 l + \Gamma_4 n \\
\frac{1}{J_y} m \\
\Gamma_4 l + \Gamma_8 n
\end{pmatrix}
$$

---

## 四、四元数归一化（科贝特-赖特正交控制）

### 4.1 问题背景

动力学方程式(B.2)和式(B.4)相对于第3章总结中的方程式(3.15)和式(3.17)是不变的。但是，当推导式(B.3)时需要确保 $\boldsymbol{e}$ 仍然是一个单位四元数。

### 4.2 目标函数

为保持 $\|\boldsymbol{e}\| = 1$，定义目标函数：
$$
J = \frac{1}{8}\left(1 - \|\boldsymbol{e}\|^2\right)^2
$$

由于 $J$ 是二次的，可以使用梯度下降使 $J$ 最小化。

### 4.3 修正后的四元数微分方程

$$
\begin{pmatrix} \dot{e}_0 \\ \dot{e}_1 \\ \dot{e}_2 \\ \dot{e}_3 \end{pmatrix} = \frac{1}{2}
\begin{pmatrix}
0 & -p & -q & -r \\
p & 0 & r & -q \\
q & -r & 0 & p \\
r & q & -p & 0
\end{pmatrix}
\begin{pmatrix} e_0 \\ e_1 \\ e_2 \\ e_3 \end{pmatrix} - \lambda \frac{\partial J}{\partial \boldsymbol{e}}
$$

展开为：
$$
= \frac{1}{2}
\begin{pmatrix}
\lambda(1 - \|\boldsymbol{e}\|^2) & -p & -q & -r \\
p & \lambda(1 - \|\boldsymbol{e}\|^2) & r & -q \\
q & -r & \lambda(1 - \|\boldsymbol{e}\|^2) & p \\
r & q & -p & \lambda(1 - \|\boldsymbol{e}\|^2)
\end{pmatrix}
\begin{pmatrix} e_0 \\ e_1 \\ e_2 \\ e_3 \end{pmatrix}
$$

**参数说明**：
- $\lambda > 0$ 是一个正增益，即指定的梯度强度
- 根据经验，$\lambda = 1000$ 几乎很好
- 在Simulink中，需要使用像ODE15s这样的求解方法
- 这种维护四元数正交性的方法称为**科贝特-赖特正交控制**（Coppelt-Wright Orthogonality Control），在1950年被首次引入，用于模拟计算机

---

## 五、重力在机体坐标系的表示

重力不依赖于飞机相对惯性参考系的姿态。在 $\boldsymbol{k}^i$ 方向的重力作用，可采用单位四元数**在机体坐标系**下表示为：

$$
\boldsymbol{f}_g^b = mg
\begin{pmatrix}
2(e_1e_3 - e_2e_0) \\
2(e_2e_3 + e_1e_0) \\
e_3^2 + e_0^2 - e_1^2 - e_2^2
\end{pmatrix}
$$

---

## 六、完整12状态6自由度动力学模型

### 6.1 位置微分方程（展开形式）

$$
\dot{p}_n = (e_1^2 + e_0^2 - e_2^2 - e_3^2)u + 2(e_1e_2 - e_3e_0)v + 2(e_1e_3 + e_2e_0)w \tag{B.5}
$$

$$
\dot{p}_e = 2(e_1e_2 + e_3e_0)u + (e_2^2 + e_0^2 - e_1^2 - e_3^2)v + 2(e_2e_3 - e_1e_0)w \tag{B.6}
$$

$$
\dot{h} = -2(e_1e_3 - e_2e_0)u - 2(e_2e_3 + e_1e_0)v - (e_3^2 + e_0^2 - e_1^2 - e_2^2)w \tag{B.7}
$$

**注意**：$\dot{h} = -\dot{p}_d$（高度是向下位置的负值）

### 6.2 速度微分方程（含气动力和推力）

$$
\dot{u} = rv - qw + 2g(e_1e_3 - e_2e_0) + \frac{\rho V_a^2 S}{2m}\left[C_X(\alpha) + C_{X_q}(\alpha)\frac{cq}{2V_a} + C_{X_{\delta_e}}(\alpha)\delta_e\right] + \frac{\rho S_{prop}C_{prop}}{2m}\left[(k_{motor}\delta_t)^2 - V_a^2\right] \tag{B.8}
$$

$$
\dot{v} = pw - ru + 2g(e_2e_3 + e_1e_0) + \frac{\rho V_a^2 S}{2m}\left(C_{Y_0} + C_{Y_\beta}\beta + C_{Y_p}\frac{bp}{2V_a} + C_{Y_r}\frac{br}{2V_a} + C_{Y_{\delta_a}}\delta_a + C_{Y_{\delta_r}}\delta_r\right) \tag{B.9}
$$

$$
\dot{w} = qu - pv + g(e_3^2 + e_0^2 - e_1^2 - e_2^2) + \frac{\rho V_a^2 S}{2m}\left[C_Z(\alpha) + C_{Z_q}(\alpha)\frac{cq}{2V_a} + C_{Z_{\delta_e}}(\alpha)\delta_e\right] \tag{B.10}
$$

### 6.3 四元数微分方程

$$
\dot{e}_0 = -\frac{1}{2}(pe_1 + qe_2 + re_3) \tag{B.11}
$$

$$
\dot{e}_1 = \frac{1}{2}(pe_0 + re_2 - qe_3) \tag{B.12}
$$

$$
\dot{e}_2 = \frac{1}{2}(qe_0 - re_1 + pe_3) \tag{B.13}
$$

$$
\dot{e}_3 = \frac{1}{2}(re_0 + qe_1 - pe_2) \tag{B.14}
$$

### 6.4 角速度微分方程（含气动力矩）

$$
\dot{p} = \Gamma_1 pq - \Gamma_2 qr + \frac{1}{2}\rho V_a^2 Sb\left(C_{p_0} + C_{p_\beta}\beta + C_{p_p}\frac{bp}{2V_a} + C_{p_r}\frac{br}{2V_a} + C_{p_{\delta_a}}\delta_a + C_{p_{\delta_r}}\delta_r\right) \tag{B.15}
$$

$$
\dot{q} = \Gamma_5 pr - \Gamma_6(p^2 - r^2) + \frac{\rho V_a^2 Sc}{2J_y}\left(C_{m_0} + C_{m_\alpha}\alpha + C_{m_q}\frac{cq}{2V_a} + C_{m_{\delta_e}}\delta_e\right) \tag{B.16}
$$

$$
\dot{r} = \Gamma_7 pq - \Gamma_1 qr + \frac{1}{2}\rho V_a^2 Sb\left(C_{r_0} + C_{r_\beta}\beta + C_{r_p}\frac{bp}{2V_a} + C_{r_r}\frac{br}{2V_a} + C_{r_{\delta_a}}\delta_a + C_{r_{\delta_r}}\delta_r\right) \tag{B.17}
$$

---

## 七、惯性参数 Γ 系数（式3.13）

$$
\Gamma = J_x J_z - J_{xz}^2
$$

$$
\Gamma_1 = \frac{J_{xz}(J_x - J_y + J_z)}{\Gamma}
$$

$$
\Gamma_2 = \frac{J_z(J_z - J_y) + J_{xz}^2}{\Gamma}
$$

$$
\Gamma_3 = \frac{J_z}{\Gamma}
$$

$$
\Gamma_4 = \frac{J_{xz}}{\Gamma}
$$

$$
\Gamma_5 = \frac{J_z - J_x}{J_y}
$$

$$
\Gamma_6 = \frac{J_{xz}}{J_y}
$$

$$
\Gamma_7 = \frac{(J_x - J_y)J_x + J_{xz}^2}{\Gamma}
$$

$$
\Gamma_8 = \frac{J_x}{\Gamma}
$$

---

## 八、空气动力系数

描述滚转和偏航力矩贡献的空气动力系数由下式给出：

### 8.1 滚转力矩系数（$C_p$ 系列）

$$
C_{p_0} = \Gamma_3 C_{l_0} + \Gamma_4 C_{n_0}
$$

$$
C_{p_\beta} = \Gamma_3 C_{l_\beta} + \Gamma_4 C_{n_\beta}
$$

$$
C_{p_p} = \Gamma_3 C_{l_p} + \Gamma_4 C_{n_p}
$$

$$
C_{p_r} = \Gamma_3 C_{l_r} + \Gamma_4 C_{n_r}
$$

$$
C_{p_{\delta_a}} = \Gamma_3 C_{l_{\delta_a}} + \Gamma_4 C_{n_{\delta_a}}
$$

$$
C_{p_{\delta_r}} = \Gamma_3 C_{l_{\delta_r}} + \Gamma_4 C_{n_{\delta_r}}
$$

### 8.2 偏航力矩系数（$C_r$ 系列）

$$
C_{r_0} = \Gamma_4 C_{l_0} + \Gamma_8 C_{n_0}
$$

$$
C_{r_\beta} = \Gamma_4 C_{l_\beta} + \Gamma_8 C_{n_\beta}
$$

$$
C_{r_p} = \Gamma_4 C_{l_p} + \Gamma_8 C_{n_p}
$$

$$
C_{r_r} = \Gamma_4 C_{l_r} + \Gamma_8 C_{n_r}
$$

$$
C_{r_{\delta_a}} = \Gamma_4 C_{l_{\delta_a}} + \Gamma_8 C_{n_{\delta_a}}
$$

$$
C_{r_{\delta_r}} = \Gamma_4 C_{l_{\delta_r}} + \Gamma_8 C_{n_{\delta_r}}
$$

**说明**：利用 $\Gamma_1, \Gamma_2, \cdots, \Gamma_8$ 指定的惯性参数由式(3.13)定义。

---

## 九、空速与气流角计算（式2.8）

由反向关系可以得出：

### 9.1 空速
$$
V_a = \sqrt{u_r^2 + v_r^2 + w_r^2}
$$

### 9.2 攻角
$$
\alpha = \arctan\left(\frac{w_r}{u_r}\right)
$$

### 9.3 侧滑角
$$
\beta = \arcsin\left(\frac{v_r}{\sqrt{u_r^2 + v_r^2 + w_r^2}}\right)
$$

**说明**：
- $u_r, v_r, w_r$ 是相对风速分量：$u_r = u - u_w$, $v_r = v - v_w$, $w_r = w - w_w$
- $(u_w, v_w, w_w)$ 是风速分量（由式2.8给出的风速分量）

---

## 十、状态向量定义

### 10.1 四元数表示的12状态向量

$$
\boldsymbol{x} = \begin{pmatrix} p_n \\ p_e \\ p_d \\ u \\ v \\ w \\ e_0 \\ e_1 \\ e_2 \\ e_3 \\ p \\ q \\ r \end{pmatrix}
$$

**注意**：使用四元数表示时，状态向量变为**13维**（比欧拉角表示多1维），但有一个约束 $\|\boldsymbol{e}\| = 1$，实际自由度仍为12。

### 10.2 状态索引

| 索引 | 状态 | 描述 |
|-----|------|------|
| 0 | $p_n$ | 北向位置 (m) |
| 1 | $p_e$ | 东向位置 (m) |
| 2 | $p_d$ | 向下位置 (m)，$h = -p_d$ |
| 3 | $u$ | 机体x轴速度 (m/s) |
| 4 | $v$ | 机体y轴速度 (m/s) |
| 5 | $w$ | 机体z轴速度 (m/s) |
| 6 | $e_0$ | 四元数标量部分 |
| 7 | $e_1$ | 四元数矢量部分x |
| 8 | $e_2$ | 四元数矢量部分y |
| 9 | $e_3$ | 四元数矢量部分z |
| 10 | $p$ | 滚转角速度 (rad/s) |
| 11 | $q$ | 俯仰角速度 (rad/s) |
| 12 | $r$ | 偏航角速度 (rad/s) |

---

## 十一、符号说明

### 11.1 状态变量
| 符号 | 说明 |
|-----|------|
| $p_n, p_e, p_d$ | NED坐标系下的位置 |
| $u, v, w$ | 机体坐标系下的速度 |
| $e_0, e_1, e_2, e_3$ | 单位四元数 |
| $p, q, r$ | 机体坐标系下的角速度 |
| $\phi, \theta, \psi$ | 欧拉角（滚转、俯仰、偏航） |

### 11.2 控制输入
| 符号 | 说明 |
|-----|------|
| $\delta_e$ | 升降舵偏角 (rad) |
| $\delta_a$ | 副翼偏角 (rad) |
| $\delta_r$ | 方向舵偏角 (rad) |
| $\delta_t$ | 油门 (0~1) |

### 11.3 物理参数
| 符号 | 说明 |
|-----|------|
| $m$ | 飞机质量 (kg) |
| $g$ | 重力加速度 (m/s²) |
| $\rho$ | 空气密度 (kg/m³) |
| $S$ | 机翼面积 (m²) |
| $b$ | 翼展 (m) |
| $c$ | 平均气动弦长 (m) |
| $J_x, J_y, J_z$ | 转动惯量 (kg·m²) |
| $J_{xz}$ | 惯性积 (kg·m²) |

### 11.4 气动参数
| 符号 | 说明 |
|-----|------|
| $V_a$ | 空速 (m/s) |
| $\alpha$ | 攻角 (rad) |
| $\beta$ | 侧滑角 (rad) |
| $C_X, C_Z$ | 机体坐标系力系数 |
| $C_{l}, C_m, C_n$ | 滚转、俯仰、偏航力矩系数 |
| $C_p, C_r$ | 组合的滚转、偏航系数 |

---

## 十二、实现注意事项

1. **四元数归一化**：每个积分步后需检查并归一化四元数，或使用科贝特-赖特正交控制
2. **奇异点**：四元数表示无万向锁问题，但欧拉角提取时 $\theta = \pm\pi/2$ 仍有问题
3. **初始化**：从欧拉角初始化四元数时，使用第二节的转换公式
4. **积分器选择**：推荐使用RK4或ODE15s（当使用正交控制时）
5. **$\lambda$ 参数**：正交控制的梯度强度，建议 $\lambda = 1000$

---

*文档完成*
