## 第7章 PID 参数调优实战指南

本章重点：理解 PID 控制在固定翼姿态稳定中的物理含义，并通过 SITL 实验掌握调参技巧。

### 7.1 PID 物理含义（连接理论）

在《小型无人机理论与控制》中，我们学习了**恢复力矩**和**阻尼力矩**。在 ArduPilot 中，这些力矩由 PID 控制器实现：

- **P（比例）**：产生“恢复力矩”。P 值越大，飞机偏离目标角度时产生的舵面恢复动作越快、越强。对应书中的静稳定性导数。
- **I（积分）**：产生“抗漂移力矩”。用于消除长期存在的微小误差（如重心偏移或持续侧风）。
- **D（微分）**：产生“阻尼力矩”。对抗快速变化的运动，防止由于 P 过大引起的震荡。对应书中的动稳定性（阻尼）导数。

### 7.2 实战准备

1. **启动环境**：按照 [第1章](#第1章-环境准备与启动) 启动 SITL 并连接 Mission Planner。
2. **备份参数**：
   - 进入 `CONFIG` -> `Full Parameter List`
   - 点击 `Save to File`，保存为 `pid_backup.param`（以便实验结束后恢复）。
3. **设置监控器（Tuning）**：
   - 在 `FLIGHT DATA` 界面勾选下方的 `Tuning`。
   - 双击黑色波形窗口，在弹出的列表中勾选：
     - `nav_roll`（目标滚转角）
     - `roll`（实际滚转角）
   - 此时你可以实时看到飞机的“目标”与“实际”跟随情况。

### 7.3 实验：滚转 PID（RLL2SRV_）

固定翼的滚转控制主要由 `RLL2SRV_` 系列参数控制。

#### 1. 基础观察：模拟摇杆输入
为了在没有真实遥控器的情况下观察 PID 作用，我们需要在 SITL 命令行（Console）中使用 `rc` 命令模拟摇杆输入。

**实验步骤：**
1. **切换模式**：在 Console 输入 `mode FBWA`。
   - *注意：必须在 FBWA 或类似姿态辅助模式下，飞控才会将 RC 输入解析为“目标角度”。*
2. **模拟打舵**：输入 `rc 1 1200`（模拟横滚向左打舵）。
   - **预期现象**：Tuning 窗口中绿线（目标横滚）瞬间跳变至 -25 到 -45 度之间。
3. **观察实际值**：
   - **地面静止时**：红线（实际横滚）通常不动，因为飞机无法在地面翻转。
   - **空中飞行时**：红线会向绿线方向迅速攀升，这个“追逐”的过程即 PID 调节过程。

#### 2. 进阶：如何看到“追逐波形”
只有让飞机飞起来，气动力才会生效，才能观察到完整的 PID 动态响应。

**操作流程：**
1. **自动起飞**：
   ```bash
   mode AUTO
   arm throttle
   ```
   - **`arm throttle` 指令详解**：
     - **物理含义**：解锁油门（拔掉安全保险）。
     - **飞控行为**：执行起飞前安全检查（Pre-Arm Checks），通过后激活电机/舵机动力系统。
     - **实验作用**：配合 `AUTO` 模式使用，飞机会立即开始地面滑跑并起飞。在未解锁状态下，任何指令（包括自动任务）都不会让电机旋转。
   - 等待飞机爬升至 50 米以上，空速稳定。
2. **切入实验模式**：
   ```bash
   mode FBWA
   ```
   - **【避坑提醒】关于“静止/悬停”的错觉**：
     - **现象**：切换模式后，如果看到地速（Groundspeed）为 0，且飞机在地图上不动，说明飞机正处于**停在地面**或**失速下坠**状态。
     - **误区**：如果高度（Altitude）显示为正数（如 17m）但地速为 0，这通常是因为当前位置的地势比 HOME 点高，飞机其实是**停在高处的地面上**，而非悬停。
     - **原理**：固定翼飞机（ArduPlane）没有悬停功能，必须有空速才有气动力。
     - **解决**：在 FBWA 模式下，必须手动维持油门。输入指令 `rc 3 1700`（模拟推油门至 70%），确保飞机有持续的前进动力，否则 PID 实验无法进行（因为舵面没有气流通过）。
3. **输入阶跃指令**：
   输入 `rc 1 1200`，观察红线追随绿线的弧度。
   - **现象分析**：如果你观察到红线“迅速跳到 25”，说明当前 P 值（恢复力矩）非常强，响应极其灵敏。
4. **回中观察**：
   输入 `rc 1 1500`，观察飞机回正的平稳度。
   - **现象分析**：红线“迅速回到 0”，说明飞机的自稳趋势很好。
   - **进阶观察点（超调与阻尼）**：
     - **现象**：红线迅速回到 0，但冲过了 0 度线（例如跳到了 +2 度）然后才晃回来。
     - **物理诊断**：**恢复力矩（P）充足，但阻尼力矩（D）不足**。系统处于“欠阻尼”状态，像没有减震器的弹簧。
     - **优化对策**：尝试小幅增加 `RLL2SRV_D` 值，直到红线能平滑地停在 0 度，不再出现过冲。

#### 3. 修改 P 值（RLL2SRV_P）对比实验
- **实验 A：减小 P 值**（改为默认值的 50% 或更低）：
  - 现象：红线追随速度变慢，波形呈现斜坡状或阶梯状，响应迟钝。
  - **实战心得**：如果发现减小 P 后响应依然尚可，通常是因为 **I 项（积分）** 较高或飞机自身具有较强的 **静稳定性**。若要观察纯粹的低 P 效应，建议暂时将 I 和 D 设为 0。
- **实验 B：增大 P 值**（改为默认值的 2 倍）：
  - 现象：红线追随极快，但容易冲过绿线（超调），甚至产生持续震荡。

#### 4. 改进：引入 D 值（RLL2SRV_D）
- 在 P 值较大的基础上，适当增加 D 值。
- **现象**：超调量减小，红线在接近绿线时能更平稳地“刹车”，抑制震荡。

### 7.4 实验：俯仰 PID（PTCH2SRV_）

俯仰控制直接关系到飞机的**飞行高度安全**。

**实验步骤：**
1. **监控设置**：在 Tuning 窗口双击，取消勾选横滚项，勾选 `nav_pitch`（目标俯仰）和 `pitch`（实际俯仰）。
2. **默认观察**：在 `FBWA` 模式下输入 `rc 2 1300`（抬头指令），观察蓝线追随橙线的速度。
3. **P 值对比实验**：
   - 找到 **Basic Tuning** 界面右侧的 **舵机 Pitch PID**。
   - 将 **P** 减小至 **0.04** 并 `Write Params`。
   - **预期现象**：飞机抬头变得极其缓慢，甚至无法维持高度。在波形图中，蓝线会远远滞后于橙线。
4. **物理连接**：由于俯仰受重力影响，低头响应通常快于抬头。调小 P 值会使飞控在应对俯仰扰动时“力不从心”。

### 7.5 实验：偏航 PID（YAW2SRV_）与协调转弯

固定翼的偏航控制（方向舵）与多旋翼截然不同，它主要用于**消除转弯侧滑（协调转弯）**。

**关键参数：**
- `YAW2SRV_RLL`：**Yaw 至 Roll 前馈增益**（核心）。根据横滚角自动联动方向舵，实现协调转弯。
- `YAW2SRV_DAMP`：**偏航阻尼**。抑制机头左右“荡漾”。
- `YAW2SRV_SLIP`：基于侧向加速度的修正。

**实战发现与结论：**
1. **物理稳定性掩盖实验**：在 SITL 默认环境下，即便将 `YAW2SRV_RLL` 设为 0，飞机转弯依然显得平稳。
   - **原因**：固定翼飞机的垂直尾翼具有天然的**风标稳定性**（$C_{n_\beta} > 0$），气流会自动压正机头。
   - **工程意义**：良好的物理设计可以大幅降低对算法增益的依赖。
2. **微观差异**：虽然视觉上不明显，但通过监控 `side_slip`（侧滑角）和 `ch4out`（4通道输出）可以发现：
   - 增益为 1.0 时：飞控主动压舵，侧滑角几乎为 0。
   - 增益为 0.0 时：方向舵不动，飞机依靠物理结构“被动”转弯，会产生 1-2 度的微小侧滑。
3. **调优策略**：对于大多数标准布局固定翼，偏航阻尼（DAMP）和积分（INT）通常设为 0 或极小值，仅依靠前馈（RLL）即可满足 90% 的飞行需求。

---

### 7.6 实验归位与总结

在完成所有对比实验后，请务必执行以下“大获全胜”操作：
1. **恢复环境**：点击 **Load from File** 加载 `pid_backup.param`，点击 **Write Params**。
2. **重启系统**：在控制台输入 `reboot`。

**调参核心心法：**
- **P（比例）**：给恢复力（对应静态稳定性）。
- **I（积分）**：给咬合力（消除静态误差）。
- **D（微分）**：给刹车力（对应动态阻尼）。
- **前馈（FF/RLL）**：给预判力（提前联动）。

### 7.6 重点参数清单

| 类别 | 参数名（常见） | 参数名（本系统） | 作用 | 物理意义 |
| :--- | :--- | :--- | :--- | :--- |
| **滚转** | `RLL2SRV_P/I/D` | **`RLL_RATE_P/I/D`** | 滚转姿态控制 | 对应静/动滚转稳定性 |
| **俯仰** | `PTCH2SRV_P/I/D` | **`PTCH_RATE_P/I/D`** | 俯仰高度控制 | 对应静/动俯仰稳定性 |
| **偏航** | `YAW2SRV_DAMP` | `YAW2SRV_DAMP` | 偏航阻尼 | 对应偏航阻尼导数 $C_{n_r}$ |
| **偏航** | `YAW2SRV_SLIP` | `YAW2SRV_SLIP` | 侧滑修正 | 对应偏航稳定性导数 $C_{n_\beta}$ |

### 7.7 实战案例分析：从“老爷爷”到“精准响应”

#### 案例 1：极限极简模型（极低 P、零 I、零 D）
- **参数配置**：`RLL2SRV_P = 0.08`, `I = 0`, `D = 0`
- **对应截图**：`./ROLL PID P 0.08 D 0.01 D 0.001.png`

**诊断报告：**
1. **典型的“阶梯状”响应（Steppy Response）**
   - **现象**：红线（实际角度）在爬升时呈现一格一格的阶梯状，而非平滑曲线。
   - **物理诊断**：由于 **P 值（恢复力矩）太小**，飞控输出给舵机的指令微乎其微。飞机在空气阻力作用下，舵机每次只能勉强把飞机“撬动”一点点。
   - **后果**：响应极其滞后（从 1240s 开始，直到 1241.5s 才第一次碰到目标线，延迟达 1.5 秒）。
2. **严重的“震荡与过冲”（Undamped Oscillation）**
   - **现象**：在到达 -40 度时，红线直接冲到了 -48 度（严重超调）；回中到 0 度时，红线直接冲到了 +8 度，然后又晃回 -2 度。
   - **物理诊断**：这就是 **D 项（阻尼）为 0** 的代价。飞机在运动中积累了旋转动能，但系统没有任何“刹车”机制，只能像没有减震器的弹簧一样靠物理阻力自然耗散。
3. **稳态误差（Steady-state Error）**
   - **现象**：在 1242s 到 1245s 之间，红线在 -40 附近上下晃动，始终不能稳稳地停在绿线上。
   - **物理诊断**：这是 **I 项（积分）为 0** 的结果，系统失去了消除长期累积误差的能力。

#### 案例 2：优化后的健康系统
- **参数配置**：`RLL2SRV_P = 0.4`, `I = 0.25`, `D = 0.025`
- **对应截图**：`./ROLL PID P 0.4 I 0.25 D 0.025.png`

**诊断报告：**
- **响应速度质变**：从绿线跳变到红线开始追随几乎没有延迟。P 项（0.400）提供了足够的初始力矩，瞬间克服惯性。
- **积分“咬合力”**：在 -40 度平台上，红线与绿线几乎完全重合。I 项（0.250）消除了所有静差。
- **阻尼“降噪”**：回中到 0 时，虽然有极小过冲（约 3.5 度），但迅速收敛。D 项（0.025）有效吸收了多余动能，避免了反复震荡。

#### 案例 3：极限不稳定与系统崩溃（极高 P 值）
- **参数配置**：`RLL_RATE_P = 1.5 ~ 2.0`, `I = 0`, `D = 0`
- **真实记录与诊断**：
  1. **传感器失效报警**：在 SITL 仿真中，当底层 RATE P 调得过大时，HUD 可能弹出红字：`Airspeed sensor 1 failure. Disabling`。
  2. **物理逻辑**：极高增益导致飞控内部指令超高频跳变，这种“非物理”的剧烈震荡触发了飞控的一致性检查保护，禁用了空速计并进入“安全模式”。
  3. **现象反直觉**：有时参数调得极大，飞机却反而像“死机”一样不动，这正是系统为了防崩溃而牺牲了部分失灵传感器的表现。

### 7.8 总结：调参口诀

- **先增 P**：直到飞机出现可见的轻微震荡（超调）。
- **再加 D**：直到震荡消失，响应依然快速。
- **后加 I**：消除最终的角度静差（例如飞机总是侧着飞一点点）。
- **微调**：在不同空速下测试，确保全速域稳定。
