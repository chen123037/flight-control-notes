# 坐标系变换笔记

> 第 3 周学习产出
> 参考：《小型无人机理论与控制》第 2-3 章
> 创建日期：2026-02-02
> 更新日期：待填写

---

## 1. 坐标系定义

### 1.1 惯性坐标系（NED）

**定义**：North-East-Down 坐标系，固定于地球表面

| 轴 | 方向 | 正向 |
|----|------|------|
| X | 北 (North) | 指向正北 |
| Y | 东 (East) | 指向正东 |
| Z | 下 (Down) | 指向地心 |

**用途**：导航计算、位置表示

**符号**：$\mathcal{F}^i$ 或 $\mathcal{F}^n$

---

### 1.2 机体坐标系（Body Frame）

**定义**：固连于飞机，随飞机运动

| 轴 | 方向 | 正向 |
|----|------|------|
| X | 前 (Forward) | 指向机头 |
| Y | 右 (Right) | 指向右翼 |
| Z | 下 (Down) | 垂直向下 |

**用途**：力/力矩分析、姿态控制

**符号**：$\mathcal{F}^b$

---

### 1.3 稳定坐标系（Stability Frame）

**定义**：机体系绕 Y 轴旋转攻角 α

**用途**：气动分析（分离升力和阻力方向）

**符号**：$\mathcal{F}^s$

---

### 1.4 风轴坐标系（Wind Frame）

**定义**：X 轴沿来流方向

**用途**：升阻力分析

**符号**：$\mathcal{F}^w$

---

## 2. 旋转表示

### 2.1 基本旋转矩阵

**绕 X 轴旋转（滚转 φ）**：
```
R_x(φ) = | 1     0        0    |
         | 0   cos(φ)   sin(φ) |
         | 0  -sin(φ)   cos(φ) |
```

**绕 Y 轴旋转（俯仰 θ）**：
```
R_y(θ) = | cos(θ)   0   -sin(θ) |
         |   0      1      0    |
         | sin(θ)   0    cos(θ) |
```

**绕 Z 轴旋转（偏航 ψ）**：
```
R_z(ψ) = |  cos(ψ)   sin(ψ)   0 |
         | -sin(ψ)   cos(ψ)   0 |
         |    0        0      1 |
```

---

### 2.2 欧拉角（ZYX 顺序）

**旋转顺序**：先偏航(ψ) → 再俯仰(θ) → 最后滚转(φ)

**机体系到惯性系的旋转矩阵**：
```
R_b^i = R_z(ψ) × R_y(θ) × R_x(φ)
```

**展开形式**：
```
R_b^i = | cθcψ         cθsψ         -sθ   |
        | sφsθcψ-cφsψ  sφsθsψ+cφcψ  sφcθ  |
        | cφsθcψ+sφsψ  cφsθsψ-sφcψ  cφcθ  |

其中 c = cos, s = sin
```

**万向锁**：当 θ = ±90° 时，φ 和 ψ 的效果相同，丢失一个自由度

---

### 2.3 四元数

**定义**：
```
q = [q0, q1, q2, q3]^T = [cos(θ/2), e·sin(θ/2)]^T
```
其中 e 是旋转轴单位向量，θ 是旋转角度

**四元数乘法**：
```
p ⊗ q = | p0q0 - p1q1 - p2q2 - p3q3 |
        | p0q1 + p1q0 + p2q3 - p3q2 |
        | p0q2 - p1q3 + p2q0 + p3q1 |
        | p0q3 + p1q2 - p2q1 + p3q0 |
```

**四元数转旋转矩阵**：
```
R(q) = | 1-2(q2²+q3²)  2(q1q2-q0q3)  2(q1q3+q0q2) |
       | 2(q1q2+q0q3)  1-2(q1²+q3²)  2(q2q3-q0q1) |
       | 2(q1q3-q0q2)  2(q2q3+q0q1)  1-2(q1²+q2²) |
```

**优势**：
1. 无万向锁
2. 计算效率高
3. 插值平滑

---

## 3. 坐标变换

### 3.1 位置变换

**从机体系到惯性系**：
```
p_i = R_b^i × p_b + p_origin
```

**从惯性系到机体系**：
```
p_b = (R_b^i)^T × (p_i - p_origin)
```

---

### 3.2 速度变换

**机体速度到惯性系**：
```
[ṗn]       [u]
[ṗe] = R_b^i × [v]
[ṗd]       [w]
```

---

### 3.3 角速度变换

**欧拉角速率与角速度关系**：
```
[p]       [φ̇]   [    0    ]   [  0  ]
[q] = R_x(φ)^T × [    0    ] + R_x(φ)^T × R_y(θ)^T × [  0  ]
[r]       [    0    ]   [ψ̇ ]
              + [  0  ]
                [θ̇ ]
                [  0  ]
```

**简化形式**：
```
[φ̇]   | 1   sinφtanθ   cosφtanθ | [p]
[θ̇] = | 0     cosφ      -sinφ   | [q]
[ψ̇]   | 0   sinφsecθ   cosφsecθ | [r]
```

---

## 4. 万向锁问题与解决

### 4.1 问题描述

当俯仰角 θ = ±90° 时：
- 滚转轴和偏航轴共线
- 三个欧拉角只能描述两个自由度
- 姿态表示产生奇异

### 4.2 解决方案

| 方案 | 优点 | 缺点 |
|------|------|------|
| 四元数 | 无奇异、计算快 | 物理意义不直观 |
| 旋转向量 | 紧凑 | 角度超过 2π 有问题 |
| 方向余弦矩阵 | 无奇异 | 9 个参数冗余 |

**飞控中的选择**：
- 内部计算：四元数
- 显示/输入：欧拉角

---

## 5. ArduPilot 中的坐标系

### 5.1 ArduPilot 坐标约定

- 使用 NED 坐标系
- 机体系遵循前-右-下约定
- 姿态用四元数内部计算，欧拉角对外显示

### 5.2 相关代码位置

```
libraries/AP_Math/
├── quaternion.h      # 四元数类
├── matrix3.h         # 旋转矩阵
├── vector3.h         # 三维向量
└── rotations.h       # 旋转定义
```

---

## 附录：Python 代码说明

代码位置：`code/coordinate_visualization/`

### 主要文件

| 文件 | 功能 |
|------|------|
| `coordinate_systems.py` | 坐标系定义与绘制 |
| `rotation_matrix.py` | 旋转矩阵计算与可视化 |
| `euler_angles.py` | 欧拉角演示 |
| `quaternion.py` | 四元数演示 |
| `demo.py` | 综合演示 |

### 运行方式

```bash
cd code/coordinate_visualization
python demo.py
```

---

*坐标系变换笔记 - 待完善*
