## 第10章 安全与限制参数实战指南

本章目标：在 SITL 中理解“飞行限制、故障保护、解锁检查”的作用边界，并完成可复现实验记录。

### 10.1 原理速览（只记 4 句）
1. **飞行限制**是“边界约束”，用于限制速度、高度与姿态，不是调出性能。
2. **故障保护**是“失控后动作”，用于链接信号丢失、围栏触发等风险场景。
3. **解锁检查**是“上电前风险过滤”，不通过则无法解锁。
4. **安全参数实验的核心**是“触发条件 → 行为 → 结果”，要记录完整链路。

### 10.2 实验前准备
1. **备份参数**：`CONFIG` → `Full Parameter List` → `Save to File`。
2. **准备场景**：使用一条已知可飞的航线或能手动切换模式的环境，确保能触发 `RTL` 或 `LOITER`。
   - 本次使用航线：`../../06-实践记录/SITL/20260129.waypoints`
3. **开启 Tuning**：至少勾选 `alt` / `targetalt` / `groundspeed`。
4. **基线记录（明确操作）**：
   - 起飞后，**切换到 `RTL` 模式**，让飞机进入返航盘旋。
   - 在**进入盘旋并高度稳定**时截图：`alt/targetalt` 曲线 + 当前模式显示。
   - 如有告警，截一张“消息”窗口；无告警则记录“无告警”。

**基线记录（截图读数）**：
- RTL 触发时：`targetalt` 87.5~100（均值 98.78）；`alt` 50.02~80.32（均值 63.44）；
  `groundspeed` 21.94~24.71（均值 22.92）；`airspeed` 20.82~23.85（均值 21.8）
- 盘旋稳定：`targetalt` 100~100（均值 100）；`alt` 99.86~99.95（均值 99.9）；
  `groundspeed` 23.51~23.63（均值 23.54）；`airspeed` 22.00~22.09（均值 22.04）

**基线结论**：
- RTL 高度生效正常：目标高度稳定为 100 m，盘旋高度贴近 100 m。
- 高度跟随平稳：从 50 m 逐步拉升到目标高度，无明显异常跳变。
- 速度稳定：地速/空速波动小，动力与阻力平衡正常。
- 无告警：可作为后续改参对照基线。

### 10.3 关键参数与意义
| 参数 | 作用 | 默认值 |
|------|------|--------|
| `ARSPD_FBW_MIN` | FBW 最小空速 | 10 m/s |
| `ARSPD_FBW_MAX` | FBW 最大空速 | 30 m/s |
| `RTL_ALTITUDE` | RTL 返航高度 | 100 m |
| `FENCE_ENABLE` | 围栏使能 | 0 |
| `FS_SHORT_ACTN` | 短时失控动作 | 0 |
| `FS_LONG_ACTN` | 长时失控动作 | 0 |
| `ARMING_CHECK` | 解锁检查项 | 1 (全部) |

### 10.4 实验步骤（按顺序完成）
**实验 1：`RTL_ALTITUDE`（RTL 返航高度）**
1. 记录默认值与基线 RTL 高度。
2. 将 `RTL_ALTITUDE` 改为 80，执行一次 RTL。
3. 记录高度曲线与盘旋高度是否变化。

**实验 1 记录（RTL_ALTITUDE=80，盘旋段）**：
- 说明：默认值 100，无告警。不同固件参数名可能为 `RTL_ALT` 或 `RTL_ALTITUDE`。
- `targetalt` 80~80（均值 80）；`alt` 79.85~79.97（均值 79.91）
- `groundspeed` 23.43~23.57（均值 23.51）；`airspeed` 21.96~22.08（均值 22.03）
- 结论：RTL 返航高度随 `RTL_ALT` 改为 80，盘旋高度稳定贴近 80 m，速度稳定。

**实验 2：`FENCE_ENABLE`（围栏触发）**
1. 设置 `FENCE_ENABLE=1`。
2. 选择可触发围栏的路径或模拟越界行为。
3. 记录触发后的模式变化与告警信息。

**实验 2 记录（FENCE_ENABLE=1）**：
- 说明：默认值 0，触发后自动进入 RTL。
- 告警信息：`Fence Breach BOUNDARY`
- `targetalt` 50~100（均值 83.02）；`alt` 50.05~67.39（均值 55.62）
- `groundspeed` 22.75~24.8（均值 23.7）；`airspeed` 21.54~23.86（均值 22.45）
- 结论：围栏越界触发保护动作，模式切换到 RTL，告警提示正常。

**实验 3：ARMING 参数组（解锁检查）**
1. 说明：当前固件未提供 `ARMING_CHECK`，改用 `ARMING_*` 参数组进行解锁检查。
2. 关键参数解读：
   - `ARMING_REQUIRE=1`：解锁必须满足检查条件（核心开关）。
   - `ARMING_OPTIONS`：解锁行为选项，当前为 0（无额外行为）。
   - `ARMING_MIS_ITEMS`：任务项检查位掩码，当前为 0（不要求任务项也可解锁）。
   - `ARMING_ACCTHRESH`：加速度计误差阈值，超出可能导致解锁失败。
   - `ARMING_MAGTHRESH`：磁罗盘磁场误差阈值，超出可能导致解锁失败。
   - `ARMING_RUDDER`：方向舵解锁/上锁选项。
   - `ARMING_SKIPCHK`：跳过检查的位掩码，当前为 0（不跳过）。
3. 记录方法：尝试解锁失败时查看“消息”窗口提示，映射到上述检查项。

**补充记录：FS 失控动作参数（仅理解含义，不做实验）**
- `FS_SHORT_ACTN`：短时失控动作，默认 0（本次未做实验）。
- `FS_LONG_ACTN`：长时失控动作，默认 0（本次未做实验）。

**可选实验：`ARSPD_FBW_MIN/MAX`**
1. 仅在理解空速含义后小幅调整，观察是否触发速度相关告警。
2. 记录速度曲线与飞行稳定性变化。
3. 说明：当前固件未找到 `ARSPD_FBW_MIN/MAX` 或相关 `ARSPD_` 参数时，本实验可直接跳过。

### 10.5 指标解读（如何从结果得结论）
1. **RTL 高度**：`RTL_ALTITUDE` 改动后，盘旋高度是否同步改变。
2. **围栏触发**：是否出现模式切换、告警提示与回航/盘旋行为。
3. **解锁检查**：触发项是否清晰可复现，提示是否能指导排错。
4. **速度限制**：`ARSPD_FBW_MIN/MAX` 改动后是否出现速度偏离或保护。

### 10.6 记录模板（直接复制）
```
日期：
实验环境：SITL / Mission Planner
基线参数：ARSPD_FBW_MIN=__ / ARSPD_FBW_MAX=__ / RTL_ALTITUDE=__ / FENCE_ENABLE=__ / FS_SHORT_ACTN=__ / FS_LONG_ACTN=__ / ARMING_CHECK=__

实验 1（RTL_ALTITUDE）：
- 改动值：
- 现象（高度曲线/盘旋高度）：
- 结论：

实验 2（FENCE_ENABLE）：
- 触发方式：
- 现象（模式切换/告警）：
- 结论：

实验 3（ARMING_CHECK）：
- 触发项与提示：
- 解决方式：
- 结论：
```

### 10.7 截图清单（务必保留）
1. 参数列表截图（改动前后）
2. RTL 高度曲线截图（`alt/targetalt`）
3. 围栏触发告警截图
4. 解锁检查提示截图

### 10.8 常见问题排查
- **改了 RTL 高度但看不出变化**：确认已触发 RTL 且高度曲线显示 `alt/targetalt`。
- **围栏无反应**：确认围栏类型与边界是否配置正确，且 `FENCE_ENABLE=1`。
- **无法解锁**：查看解锁提示，逐项排除传感器与模式限制。

### 10.9 实验结束与归档
1. 将参数恢复为基线或备份值。
2. 在周四记录中补齐“学习时长 / 完成情况 / 遇到问题”。
3. 将截图与调参日志存入本周记录目录。
