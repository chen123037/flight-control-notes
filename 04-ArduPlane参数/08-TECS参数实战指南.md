## 第8章 TECS 参数实战指南（纵向控制）

本章目标：在 SITL 中理解 TECS（总能量控制系统）如何协同管理“高度/空速”，并完成可复现的调参实验记录。

### 8.1 原理速览（只记 3 句）
1. TECS 用“总能量”视角同时管高度与空速：高度=势能，空速=动能。
2. 俯仰主要影响空速变化趋势，油门主要影响能量总量。
3. 关键参数决定爬升/下降速率与响应快慢，过度设置会导致振荡或超调。

### 8.2 实验前准备
1. **备份参数**：`CONFIG` → `Full Parameter List` → `Save to File`。
2. **开启 Tuning**：`FLIGHT DATA` → 勾选 `Tuning` → 双击波形窗口，建议勾选：
   - `alt`、`nav_alt`
   - `airspeed` 或 `aspd`、`nav_airspeed`
   - `pitch`、`nav_pitch`
   - `throttle` 或 `throttle_out`
3. **基线记录**：在不改参数时先飞一遍，记录爬升/下降速度、到高到低的滞后与超调。
   - 记录要点示例：
     - 爬升段：实际爬升率约 __ m/s（例如 3.5 m/s）
     - 下降段：实际下降率约 __ m/s（例如 2.8 m/s）
     - 超调：到目标高度后是否超过 __ m（例如 +12 m）
     - 俯仰：是否有明显抖动或过冲（例如轻微抖动）
   - 本次基线记录（截图提取，未勾选 nav_alt）：
     - 爬升段：alt 62.97~66.88（均值 64.56），climbrate -1.53~0.83（均值 0.29），pitch -7.15~-1.79
     - 下降段：alt 64.96~73.82（均值 69.37），climbrate -1.09~-0.86（均值 -0.98），pitch -6.27~-5.70
     - 到达指定高度1：alt 79.28~80.06（均值 79.75），climbrate -0.02~0.32（均值 0.09）
     - 盘旋：alt 79.94~80.71（均值 80.34），climbrate -0.36~0.28（均值 -0.04）
     - 转向-到达指定高度2：alt 87.43~101.26（均值 95.30），climbrate -5.71~4.90（均值 -0.81）
     - 开始返航：alt 68.29~78.82（均值 73.36），climbrate 0.40~2.27（均值 1.16）
     - 转向-到达指定高度3：alt 44.55~50.99（均值 47.21），climbrate -1.06~2.49（均值 -0.57）
   - 本次基线记录（勾选 targetalt，用于超调判断）：
     - 超调-爬升：targetalt 84.97~91.94（均值 88.40），alt 82.90~89.64（均值 86.18），climbrate 0.62~0.93（均值 0.73）
     - 超调-下降：targetalt 63.07~72.03（均值 67.26），alt 65.77~74.67（均值 70.11），climbrate -1.07~-0.91（均值 -0.98）
     - 超调-到达指定高度：targetalt 72.43~80.00（均值 77.09），alt 69.04~79.19（均值 74.18），climbrate 0.34~2.56（均值 1.13）
     - 超调-到达指定高度2：targetalt 43.27~48.13（均值 45.21），alt 44.67~50.91（均值 47.19），climbrate -1.11~2.63（均值 -0.54）
     - 超调-盘旋：targetalt 80.00~80.00（均值 80.00），alt 79.70~79.91（均值 79.82），climbrate -0.03~0.11（均值 0.03）

### 8.3 航线规划（必含爬升与下降）
以你本次航线为准（`20260127 1st fly.waypoints`）：
1. `TAKEOFF`：50 m
2. 航点 1：80 m
3. 航点 2：40 m
4. 航点 3：80 m
5. `LOITER`：2 圈（高度 80 m）
6. 航点 4：100 m
7. `LAND`：0 m

### 8.4 关键参数与实验步骤
**参数一：`TECS_CLMB_MAX`（最大爬升率）**
1. 记录默认值（通常 5 m/s）。
2. 试验 A：改小（例如 2 m/s），写入并飞行。
   - 观察：爬升变慢、到达目标高度滞后增大。
3. 试验 B：改大（例如 8 m/s），写入并飞行。
   - 观察：爬升更猛、俯仰变化更大，可能出现超调。

**指标解读（用于读图得结论）**：
- `climbrate`：垂直速度（m/s），均值越大爬升越快；为负表示下降。
- `alt`：实际高度（m）；`targetalt`：目标高度（m）。
- 结论推导规则：
  - `climbrate` 均值很小 → 爬升慢；均值很大 → 爬升快。
  - `alt` 均值低于 `targetalt` → 高度滞后；高于 `targetalt` → 超调。

**参数一记录（按模板）**：
```
日期：2026-01-27
航线：包含爬升/下降/盘旋（20260127 1st fly.waypoints）
基线参数：TECS_CLMB_MAX=5 / TECS_SINK_MAX=__ / TECS_TIME_CONST=__
试验 A（改动）：
- 参数与改动值：TECS_CLMB_MAX=2（对应“参数一A-*”）
- 现象：爬升1-A climbrate 均值 0.43；爬升2-A climbrate 均值 0.49；到达高度-A alt 均值 78.22（targetalt 均值 78.66）
- 结论：爬升速度偏慢，目标高度略滞后
试验 B（改动）：
- 参数与改动值：TECS_CLMB_MAX=8（对应“参数一B-*”）
- 现象：爬升1-B climbrate 均值 -0.01；爬升2-B climbrate 均值 1.16；到达高度-B alt 均值 80.01（targetalt 均值 79.93）
- 结论：爬升速度提升，目标高度更贴近
```

**参数二：`TECS_SINK_MAX`（最大下降率）**
1. 记录默认值（通常 5 m/s）。
2. 试验 A：改小（例如 2~3 m/s），写入并飞行。
   - 观察：下降变慢，航段内难以下到目标高度。
3. 试验 B：改大（例如 8 m/s），写入并飞行。
   - 观察：下降更快，可能出现高度过冲或俯仰抖动。

**参数二记录（按模板）**：
```
日期：2026-01-27
航线：包含爬升/下降/盘旋（20260127 1st fly.waypoints）
基线参数：TECS_CLMB_MAX=5 / TECS_SINK_MAX=__ / TECS_TIME_CONST=__
试验 A（改动）：
- 参数与改动值：TECS_SINK_MAX=2（对应“参数二A-*”）
- 现象：下降1-A climbrate 均值 -0.94；下降2-A climbrate 均值 -0.70；
        到达高度40-A alt 均值 46.20（targetalt 均值 45.03）
- 结论：下降速度偏慢，目标高度整体偏高，存在滞后
试验 B（改动）：
- 参数与改动值：TECS_SINK_MAX=8（对应“参数二B-*”）
- 现象：下降1-B climbrate 均值 -0.98；下降2-B climbrate 均值 -1.32；
        到达高度40-B alt 均值 46.80（targetalt 均值 45.15）
- 结论：下降速度更快，局部出现轻微过冲，但到达高度仍略偏高
```

**参数三：`TECS_TIME_CONST`（时间常数，响应快慢）**
1. 记录默认值（通常 5 s）。
2. 试验 A：改大（例如 10 s）。
   - 观察：响应更平滑，但“跟随慢”。
3. 试验 B：改小（例如 3 s）。
   - 观察：响应更快，但更容易超调或振荡。

**参数三记录（按模板）**：
```
日期：2026-01-27
航线：包含爬升/下降/盘旋（20260127 1st fly.waypoints）
基线参数：TECS_CLMB_MAX=5 / TECS_SINK_MAX=__ / TECS_TIME_CONST=__
试验 A（改动）：
- 参数与改动值：TECS_TIME_CONST=10（对应“参数三A-*”）
- 现象：爬升-A climbrate 均值 1.13（alt 均值 51.06 / targetalt 均值 55.55）；
        下降-A climbrate 均值 -1.02（alt 均值 66.22 / targetalt 均值 63.50）；
        到达高度80-A alt 均值 77.28（targetalt 均值 78.62）
- 结论：响应更平滑，但高度跟随略慢，存在轻微滞后
试验 B（改动）：
- 参数与改动值：TECS_TIME_CONST=3（对应“参数三B-*”）
- 现象：爬升1-B climbrate 均值 1.12（alt 均值 74.55 / targetalt 均值 77.25）；
        爬升2-B climbrate 均值 1.20（alt 均值 72.64 / targetalt 均值 75.85）；
        到达高度80-B alt 均值 79.76（targetalt 均值 80.00）
- 结论：响应更快，到达高度更贴近目标，但俯仰波动略明显
```

**安全边界参数（仅确认值，不建议大幅改动）**
- `TECS_PITCH_MAX` / `TECS_PITCH_MIN`：限制俯仰角，避免过大抬头或俯冲。

### 8.5 记录模板（直接复制）
```
日期：
航线：包含爬升/下降/盘旋
基线参数：TECS_CLMB_MAX=__ / TECS_SINK_MAX=__ / TECS_TIME_CONST=__
试验 A（改动）：
- 参数与改动值：
- 现象（爬升/下降速度、俯仰、空速、超调）：
- 结论：
试验 B（改动）：
- 参数与改动值：
- 现象：
- 结论：
```

### 8.6 截图清单（务必保留）
1. 航线规划界面（含高低航点高度）
2. Tuning 波形（`alt/nav_alt`、`airspeed/nav_airspeed`、`pitch/nav_pitch`）
3. 爬升段与下降段各 1 张（能看出高度变化与俯仰响应）

### 8.7 常见问题排查
- **看不到空速曲线**：检查是否已勾选 `airspeed` 或 `aspd` 项；SITL 中空速可能在起飞前为 0。
- **高度不变化**：确认航点高度差足够大，且已 `Write WPs` 后在 `AUTO` 中执行。
- **下降太慢**：检查 `TECS_SINK_MAX` 是否过小，或航段长度不足。
- **还没到 40 m 就开始转弯、实际高度偏高**：通常是航点判定半径或转弯提前量导致提前切航段，`targetalt` 提前切到下一段；同时 TECS 有滞后，短航段内来不及降到目标高度。可用 `targetalt` 的跳变、`DistToMAV` 变化来确认；必要时加长航段或适当减小航点半径。

### 8.7.1 读图判据（如何得出“更快/更平滑/跟随慢”）
1. **找起点**：`targetalt` 发生跳变的时刻就是响应起点。
2. **看收敛时间**：`alt` 进入 `targetalt ±1~2 m` 的时间越短 → “更快”；越长 → “跟随慢”。
3. **看超调**：`alt` 超过 `targetalt` 的峰值越大 → “更激进/更快但易超调”。
4. **看波动**：`pitch` 或 `climbrate` 出现明显波纹 → “不够平滑”。
5. **看稳态误差**：`alt` 长时间低于/高于 `targetalt` → “滞后/偏高”。

### 8.8 实验结束与归档
1. 将参数恢复为基线或备份值。
2. 在周二记录中补齐“学习时长 / 完成情况 / 遇到问题”。
3. 将截图与调参日志存入本周记录目录。
